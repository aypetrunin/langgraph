resolver 127.0.0.11 valid=10s ipv6=off;

server {
  listen 8080;

  set $cors_origin "https://smith.langchain.com";

  location / {
    # CORS на все обычные ответы
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Vary "Origin" always;

    # Preflight
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Vary "Origin" always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
      add_header Access-Control-Allow-Headers $http_access_control_request_headers always;
      add_header Access-Control-Max-Age 86400 always;
      return 204;
    }

    # Убираем CORS заголовки апстрима, чтобы не было дублей
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header access-control-allow-origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header access-control-allow-credentials;
    proxy_hide_header Access-Control-Expose-Headers;
    proxy_hide_header access-control-expose-headers;

    proxy_pass http://langgraph-api:8000;
    proxy_http_version 1.1;
  }
}

